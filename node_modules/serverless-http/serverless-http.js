'use strict';

const finish = require('./lib/finish');
const getFramework = require('./lib/framework/get-framework');
const getProvider = require('./lib/provider/get-provider');

const defaultOptions = {
  requestId: 'x-request-id'
};

module.exports = function (app, opts) {
  const options = Object.assign({}, defaultOptions, opts);

  const framework = getFramework(app);
  const provider = getProvider(options);

  return provider(async (request, ...context) => {
    await finish(request, options.request, ...context);

    const fResponse = await framework(request);
    await finish(fResponse, options.response, ...context);
    const response = {
      statusCode: 200,
      headers: {
          "Access-Control-Allow-Headers" : "Content-Type",
          "Access-Control-Allow-Origin": "https://master.d3s10xhhiupkua.amplifyapp.com/",
          "Access-Control-Allow-Methods": "OPTIONS,POST,GET"
      },
      body: fResponse
    }
    return response;
  });
};


